name: Build and Release Multicore

on:
  push:
    tags: [ "v*" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential git wget unzip

    - name: Install toolchain
      run: |
        chmod +x install-toolchain.sh
        ./install-toolchain.sh

    - name: Download and extract bisrv.zip
      run: |
        wget https://github.com/Dteyn/Datafrog_SF2000_Vanilla/releases/download/v1.6/bisrv.zip
        unzip bisrv.zip
        # 假设解压后得到的文件是 BISRV.ASD，根据实际情况调整
        cp bisrv.asd bisrv_08_03.asd

    - name: Build working cores
      run: |
        chmod +x buildcoresworking.sh
        ./buildcoresworking.sh

    - name: Create sdcard directory structure
      run: |
        mkdir -p sdcard/cores
        mkdir -p sdcard/roms
        # 复制构建好的核心文件到 sdcard/cores 目录
        find . -name "*.core" -exec cp {} sdcard/cores/ \;
        # 复制其他必要文件
        cp -r patches sdcard/ 2>/dev/null || true
        cp README.md sdcard/

    - name: Create zip archive
      run: |
        cd sdcard
        zip -r ../dy19_multicore_sdcard.zip .
        cd ..

    - name: Create release
      uses: softprops/action-gh-release@v2
      with:
        files: dy19_multicore_sdcard.zip
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
