name: Build and Release Multicore

on:
  push:
    tags: [ "v*" ]
  workflow_dispatch:
    inputs:
      source_branch:
        description: "请选择游戏机型号"
        required: false
        default: "DY-19"
        type: choice
        options:
          - DY-19
          - DY-12
          - SF2000
          - GB300
      releaseTag:
        description: '发布标签名称（例如：v0.0.1）'
        required: true
        default: 'v0.0.1'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: 设置编译环境
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential git wget unzip
        sudo mkdir -p /builder
        sudo chown $USER:$GROUPS /builder

    - name: 克隆源代码- [ ${{ inputs.source_branch }} ]
      id: codes
      working-directory: /builder
      run: |
        df -hT $PWD
        # 根据游戏机型号设置对应的仓库
        if [[ "${{ inputs.source_branch }}" == "DY-19" ]]; then
            REPO_URL="https://github.com/Trademarked69/dy19_multicore"
        elif [[ "${{ inputs.source_branch }}" == "DY-12" ]]; then
            REPO_URL="https://github.com/Trademarked69/dy19_multicore" 
        elif [[ "${{ inputs.source_branch }}" == "SF2000" ]]; then
            REPO_URL="https://github.com/madcock/sf2000_multicore"
        elif [[ "${{ inputs.source_branch }}" == "GB300" ]]; then
            REPO_URL="https://github.com/tzubertowski/gb300_multicore"
        else
            echo "未知的游戏机型号: ${{ inputs.source_branch }}"
            exit 1
        fi
        
        echo "仓库地址: $REPO_URL"
        
        # 克隆完整项目（包含所有子模块）
        echo "克隆 ${{ inputs.source_branch }} 完整项目（包含所有核心）..."
        echo "仓库地址: $REPO_URL"
        git clone --recurse-submodules --shallow-submodules $REPO_URL multicore_project
        
        # 进入项目目录
        cd multicore_project
        
        # 安装编译工具链
        echo "安装编译工具链..."
        ./install-toolchain.sh

    - name: 下载并解压 bisrv.asd 文件
      working-directory: /builder/multicore_project
      run: |
         if [[ "${{ inputs.source_branch }}" == "DY-19" ]]; then
              echo "下载 DY-19 bisrv 文件..."
              wget -O bisrv_DY19_to_SF2000_918Mhz.asd "https://raw.githubusercontent.com/kygsmsc/dy19_multicore/master/bisrv_DY19_to_SF2000_918Mhz.asd"
              # 文件已经命名为 bisrv_DY19_to_SF2000_918Mhz.asd，无需重命名
          elif [[ "${{ inputs.source_branch }}" == "DY-12" ]]; then
              echo "下载 DY-12 bisrv 文件..."
              wget -O bisrv_DY19_to_SF2000_918Mhz.asd "https://raw.githubusercontent.com/kygsmsc/dy19_multicore/master/DY-12_bisrv.asd"
              # 将 DY-12_bisrv.asd 下载并重命名为 bisrv_DY19_to_SF2000_918Mhz.asd
          elif [[ "${{ inputs.source_branch }}" == "SF2000" ]]; then
              wget https://github.com/Dteyn/Datafrog_SF2000_Vanilla/releases/download/v1.6/bisrv.zip
              unzip bisrv.zip
              # 假设解压后得到的文件是 BISRV.ASD，根据实际情况调整
              cp bisrv.asd bisrv_08_03.asd
          elif [[ "${{ inputs.source_branch }}" == "GB300" ]]; then
              wget https://github.com/Dteyn/Datafrog_SF2000_Vanilla/releases/download/v1.6/bisrv.zip
              unzip bisrv.zip
              # 假设解压后得到的文件是 BISRV.ASD，根据实际情况调整
              cp bisrv.asd bisrv_08_03.asd
          else
            echo "未知的游戏机型号: ${{ inputs.source_branch }}"
            exit 1
          fi
       

    - name: 构建模拟器核心
      working-directory: /builder/multicore_project
      run: |
        chmod +x buildcoresworking.sh
        ./buildcoresworking.sh

    - name: 创建SD卡目录结构
      working-directory: /builder/multicore_project
      run: |
        mkdir -p sdcard/cores
        mkdir -p sdcard/roms
        # 复制构建好的核心文件到 sdcard/cores 目录
        find . -name "*.core" -exec cp {} sdcard/cores/ \;
        # 复制其他必要文件
        cp -r patches sdcard/ 2>/dev/null || true
        cp README.md sdcard/

    - name: 创建 zip 压缩文件
      working-directory: /builder/multicore_project
      run: |
        cd sdcard
        # 根据游戏机型号生成不同的zip文件名
        if [[ "${{ inputs.source_branch }}" == "DY-19" ]]; then
            zip -r ../${GITHUB_REPOSITORY##*/}_dy19_sdcard.zip .
        elif [[ "${{ inputs.source_branch }}" == "DY-12" ]]; then
            zip -r ../${GITHUB_REPOSITORY##*/}_dy12_sdcard.zip .
        elif [[ "${{ inputs.source_branch }}" == "SF2000" ]]; then
            zip -r ../${GITHUB_REPOSITORY##*/}_sf2000_sdcard.zip .
        elif [[ "${{ inputs.source_branch }}" == "GB300" ]]; then
            zip -r ../${GITHUB_REPOSITORY##*/}_gb300_sdcard.zip .
        else
            zip -r ../${GITHUB_REPOSITORY##*/}_multicore_sdcard.zip .
        fi
        cd ..

    - name: 创建发布版本
      uses: softprops/action-gh-release@v2
      with:
        files: |
          /builder/multicore_project/*_sdcard.zip
        generate_release_notes: true
        tag_name: ${{ github.event.inputs.releaseTag || github.ref_name }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
